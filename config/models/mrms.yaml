# MRMS - Multi-Radar Multi-Sensor Configuration
# High-resolution radar and precipitation analysis

model:
  id: mrms
  name: "MRMS - Multi-Radar Multi-Sensor"
  description: "CONUS-wide radar mosaic and precipitation analysis at ~1km resolution"
  enabled: true

# WMS/WMTS dimension configuration
# Defines which dimensions are exposed in capabilities and accepted in requests
dimensions:
  type: observation        # "observation" = TIME dimension (ISO8601 timestamps)
  time: true               # TIME dimension - observation timestamp
  elevation: false         # No vertical levels for radar data

source:
  type: aws_s3_grib2
  bucket: noaa-mrms-pds
  path_pattern: "CONUS/{product}/{date:yyyyMMdd}/MRMS_{product}.{timestamp}.grib2.gz"
  region: us-east-1
  compression: gzip

grid:
  projection: latlon
  resolution: "0.01deg"                  # ~1km
  bbox:
    min_lon: -130.0
    min_lat: 20.0
    max_lon: -60.0
    max_lat: 55.0
  dimensions:
    x: 7000
    y: 3500

schedule:
  type: observation                      # Observation data, not forecast
  poll_interval_secs: 120                # Check every 2 minutes (data updates ~2min)
  # Note: lookback_minutes is deprecated for observation models.
  # The downloader now uses retention.hours to determine how far back to look for data.
  # This ensures historical data is downloaded up to the retention limit on startup.

retention:
  hours: 1                              # Keep 1 hour of radar data
  keep_latest_observations: 60          # Always keep ~2 hours of observations (updates every ~2 min)

# Precaching configuration - disabled for now (large memory footprint ~98MB/grid)
precaching:
  enabled: false
  keep_recent: 3
  warm_on_ingest: false
  poll_interval_secs: 120
  parameters: []

# GRIB2 level type codes reference:
#   102 = height above MSL (in m)

parameters:
  # Seamless Hybrid Scan Reflectivity - the fully composited radar mosaic
  # This is the product that shows continuous coverage like Windy/NWS
  # GRIB2 codes: discipline=209 (MRMS local), category=8, number=8
  - name: REFL
    description: "Seamless Hybrid Scan Reflectivity"
    downsample: max
    grib2:
      discipline: 209                    # MRMS local table
      category: 8                        # Reflectivity category in MRMS
      number: 8                          # SeamlessHSR parameter number
    product: "SeamlessHSR_00.00"
    levels:
      - type: height_above_msl
        level_code: 102
        value: 0
        display: "0 m above MSL"
    style: reflectivity
    units: "dBZ"
    display_units: "dBZ"
    valid_range: [-30, 80]

  # Precipitation Rate
  # GRIB2 codes: discipline=209 (MRMS local), category=6, number=1
  - name: PRECIP_RATE
    description: "Precipitation Rate"
    downsample: max
    grib2:
      discipline: 209
      category: 6                        # Precipitation category in MRMS
      number: 1                          # PrecipRate parameter number
    product: "PrecipRate_00.00"
    levels:
      - type: height_above_msl
        level_code: 102
        value: 0
        display: "0 m above MSL"
    style: precip_rate
    units: "mm/hr"
    display_units: "mm/hr"
    valid_range: [0, 100]

  # Quantitative Precipitation Estimate - 1 hour
  - name: QPE_01H
    description: "1-Hour Precipitation Accumulation"
    downsample: mean
    grib2:
      discipline: 209
      category: 1
      number: 1                          # QPE
    product: "MultiSensor_QPE_01H_Pass2_00.00"
    levels:
      - type: height_above_msl
        level_code: 102
        value: 0
        display: "0 m above MSL"
    style: precipitation
    units: "mm"
    display_units: "mm"
    valid_range: [0, 200]

  # Quantitative Precipitation Estimate - 24 hour
  - name: QPE_24H
    description: "24-Hour Precipitation Accumulation"
    downsample: mean
    grib2:
      discipline: 209
      category: 1
      number: 1
    product: "MultiSensor_QPE_24H_Pass2_00.00"
    levels:
      - type: height_above_msl
        level_code: 102
        value: 0
        display: "0 m above MSL"
    style: precipitation
    units: "mm"
    display_units: "mm"
    valid_range: [0, 500]
