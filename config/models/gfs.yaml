# GFS - Global Forecast System Configuration
# NCEP Global Forecast System, 0.25° resolution
#
# Pressure levels available for ingestion:
# Lower troposphere: 1000, 975, 950, 925, 900, 850 mb
# Mid troposphere: 800, 750, 700, 650, 600, 550, 500, 450, 400, 350 mb
# Upper troposphere: 300, 250, 200, 150 mb
# Stratosphere: 100, 70, 50, 30, 20, 10 mb

model:
  id: gfs
  name: "GFS - Global Forecast System"
  description: "NCEP Global Forecast System, 0.25° resolution"
  enabled: false

# WMS/WMTS dimension configuration
# Defines which dimensions are exposed in capabilities and accepted in requests
dimensions:
  type: forecast           # "forecast" = RUN+FORECAST dimensions, "observation" = TIME dimension
  run: true                # RUN dimension - model initialization time (ISO8601)
  forecast: true           # FORECAST dimension - hours ahead from run time
  elevation: true          # ELEVATION dimension - vertical levels (from parameter definitions)

source:
  type: aws_s3
  bucket: noaa-gfs-bdp-pds
  prefix_template: "gfs.{date}/{cycle:02}/atmos"
  file_pattern: "gfs.t{cycle:02}z.pgrb2.0p25.f{forecast:03}"
  region: us-east-1

grid:
  projection: geographic
  resolution: "0.25deg"
  bbox:
    min_lon: 0.0
    min_lat: -90.0
    max_lon: 360.0
    max_lat: 90.0
  # Longitude convention: 0-360 (data is stored as 0-360, convert for -180 to 180 requests)
  lon_convention: 0_to_360

schedule:
  cycles: [ 0, 6, 12, 18 ]              # UTC hours (00z, 06z, 12z, 18z)
  forecast_hours:
    start: 0
    end: 15                          # ~15 hours of forecast
    step: 3                           # Every 3 hours
  poll_interval_secs: 3600            # Check for new data every hour
  delay_hours: 4                      # Data typically available 4 hours after cycle time

retention:
  hours: 6                          # Keep data for 6 hours
  keep_latest_runs: 1               # Always keep at least 1 complete run (safeguard)

# Precaching configuration - disabled for now
precaching:
  enabled: false
  keep_recent_cycles: 1               # Only most recent model cycle
  forecast_hours: [ 0, 3, 6, 9, 12 ]    # Key forecast hours
  warm_on_ingest: false
  poll_interval_secs: 300
  parameters: [ "TMP", "UGRD", "VGRD" ] # Most requested parameters

# GRIB2 level type codes reference (Table 4.5):
#   1 = surface
#   100 = isobaric (pressure level in Pa, displayed as mb)
#   101 = mean sea level
#   103 = height above ground (in m)
#   200 = entire atmosphere
#   214 = low cloud layer (212=bottom, 213=top)
#   224 = middle cloud layer (222=bottom, 223=top)
#   234 = high cloud layer (232=bottom, 233=top)

parameters:
  # ==========================================================================
  # Temperature Parameters
  # ==========================================================================
  
  # Surface Temperature (2m)
  - name: TMP
    description: "Temperature"
    grib2:
      discipline: 0
      category: 0
      number: 0
    downsample: mean
    levels:
      - type: height_above_ground
        level_code: 103
        value: 2
        display: "2 m above ground"
    style: temperature
    units: K
    display_units: °C
    conversion: K_to_C
    valid_range: [150, 350]  # ~-123°C to 77°C (covers all Earth temps including stratosphere)

  # Temperature at pressure levels
  - name: TMP
    description: "Temperature"
    grib2:
      discipline: 0
      category: 0
      number: 0
    downsample: mean
    levels:
      - type: isobaric
        level_code: 100
        values: [ 1000, 975, 950, 925, 900, 850, 700, 500, 300, 250, 200, 100, 70, 50, 30, 20, 10 ]
        display_template: "{value} mb"
    style: temperature
    units: K
    display_units: °C
    conversion: K_to_C
    valid_range: [150, 350]  # ~-123°C to 77°C

  # Dew Point Temperature (2m)
  - name: DPT
    description: "Dew Point Temperature"
    grib2:
      discipline: 0
      category: 0
      number: 6
    downsample: mean
    levels:
      - type: height_above_ground
        level_code: 103
        value: 2
        display: "2 m above ground"
    style: temperature
    units: K
    display_units: °C
    conversion: K_to_C
    valid_range: [150, 330]  # ~-123°C to 57°C (dew point typically lower than temp)

  # ==========================================================================
  # Wind Parameters
  # ==========================================================================

  # U-component wind at 10m and pressure levels
  - name: UGRD
    description: "U-Component of Wind"
    grib2:
      discipline: 0
      category: 2
      number: 2
    downsample: mean
    levels:
      - type: height_above_ground
        level_code: 103
        value: 10
        display: "10 m above ground"
      - type: isobaric
        level_code: 100
        values: [ 1000, 975, 950, 925, 900, 850, 700, 500, 300, 250, 200, 100 ]
        display_template: "{value} mb"
    style: wind
    units: m/s
    valid_range: [-200, 200]  # Wind components can be negative (directional)

  # V-component wind at 10m and pressure levels
  - name: VGRD
    description: "V-Component of Wind"
    grib2:
      discipline: 0
      category: 2
      number: 3
    downsample: mean
    levels:
      - type: height_above_ground
        level_code: 103
        value: 10
        display: "10 m above ground"
      - type: isobaric
        level_code: 100
        values: [ 1000, 975, 950, 925, 900, 850, 700, 500, 300, 250, 200, 100 ]
        display_template: "{value} mb"
    style: wind
    units: m/s
    valid_range: [-200, 200]  # Wind components can be negative (directional)

  # Surface wind gust
  - name: GUST
    description: "Wind Speed (Gust)"
    grib2:
      discipline: 0
      category: 2
      number: 22
    downsample: max
    levels:
      - type: surface
        level_code: 1
        display: "surface"
    style: wind
    units: m/s
    valid_range: [0, 150]  # Gusts are always positive (magnitude)

  # ==========================================================================
  # Pressure Parameters
  # ==========================================================================

  # Mean sea level pressure
  - name: PRMSL
    description: "Pressure Reduced to MSL"
    grib2:
      discipline: 0
      category: 3
      number: 1
    downsample: mean
    levels:
      - type: mean_sea_level
        level_code: 101
        display: "mean sea level"
    style: atmospheric
    units: Pa
    display_units: hPa
    conversion: Pa_to_hPa
    valid_range: [85000, 110000]  # 850-1100 hPa (extreme lows to highs)

  # Geopotential height
  - name: HGT
    description: "Geopotential Height"
    grib2:
      discipline: 0
      category: 3
      number: 5
    downsample: mean
    levels:
      - type: isobaric
        level_code: 100
        values: [ 1000, 925, 850, 700, 500, 300, 250, 200, 100, 70, 50, 30, 20, 10 ]
        display_template: "{value} mb"
    style: geopotential
    units: gpm
    valid_range: [-500, 35000]  # From below sea level to stratosphere

  # ==========================================================================
  # Moisture Parameters
  # ==========================================================================

  # Relative humidity
  - name: RH
    description: "Relative Humidity"
    grib2:
      discipline: 0
      category: 1
      number: 1
    downsample: mean
    levels:
      - type: height_above_ground
        level_code: 103
        value: 2
        display: "2 m above ground"
      - type: isobaric
        level_code: 100
        values: [ 1000, 975, 950, 925, 900, 850, 700, 500, 300 ]
        display_template: "{value} mb"
    style: humidity
    units: "%"
    valid_range: [0, 100]  # Percentage 0-100%

  # Precipitable Water (entire atmosphere column)
  - name: PWAT
    description: "Precipitable Water"
    grib2:
      discipline: 0
      category: 1
      number: 3
    downsample: mean
    levels:
      - type: entire_atmosphere
        level_code: 200
        display: "entire atmosphere"
    style: humidity
    units: kg/m^2
    display_units: mm
    valid_range: [0, 100]  # 0-100 mm precipitable water

  # ==========================================================================
  # Precipitation Parameters
  # ==========================================================================
  
  # Total Precipitation (accumulated)
  - name: APCP
    description: "Total Precipitation"
    grib2:
      discipline: 0
      category: 1
      number: 8
    downsample: mean
    levels:
      - type: surface
        level_code: 1
        display: "surface"
    style: precipitation
    units: kg/m^2
    display_units: mm
    accumulation: true
    valid_range: [0, 1000]  # 0-1000 mm accumulated precip

  # Composite Reflectivity
  - name: REFC
    description: "Composite Reflectivity"
    grib2:
      discipline: 0
      category: 16
      number: 196
    downsample: max
    levels:
      - type: entire_atmosphere
        level_code: 200
        display: "entire atmosphere"
    style: reflectivity
    units: dBZ
    valid_range: [-30, 80]  # dBZ range for radar reflectivity

  # ==========================================================================
  # Convective/Stability Parameters
  # ==========================================================================
  
  # Convective Available Potential Energy
  - name: CAPE
    description: "Convective Available Potential Energy"
    grib2:
      discipline: 0
      category: 7
      number: 6
    downsample: max
    levels:
      - type: surface
        level_code: 1
        display: "surface"
    style: cape
    units: J/kg
    valid_range: [0, 10000]  # 0-10000 J/kg (extreme CAPE > 5000)

  # Convective Inhibition
  - name: CIN
    description: "Convective Inhibition"
    grib2:
      discipline: 0
      category: 7
      number: 7
    downsample: mean
    levels:
      - type: surface
        level_code: 1
        display: "surface"
    style: cape
    units: J/kg
    valid_range: [-1000, 0]  # CIN is typically negative (inhibition)

  # ==========================================================================
  # Cloud Parameters
  # ==========================================================================
  
  # Total Cloud Cover
  - name: TCDC
    description: "Total Cloud Cover"
    grib2:
      discipline: 0
      category: 6
      number: 1
    downsample: mean
    levels:
      - type: entire_atmosphere
        level_code: 200
        display: "entire atmosphere"
    style: cloud
    units: "%"
    valid_range: [0, 100]  # Percentage 0-100%

  # Low Cloud Cover
  - name: LCDC
    description: "Low Cloud Cover"
    grib2:
      discipline: 0
      category: 6
      number: 3
    downsample: mean
    levels:
      - type: cloud_layer
        level_code: 214
        display: "low cloud layer"
    style: cloud
    units: "%"
    valid_range: [0, 100]  # Percentage 0-100%

  # Middle Cloud Cover
  - name: MCDC
    description: "Middle Cloud Cover"
    grib2:
      discipline: 0
      category: 6
      number: 4
    downsample: mean
    levels:
      - type: cloud_layer
        level_code: 224
        display: "middle cloud layer"
    style: cloud
    units: "%"
    valid_range: [0, 100]  # Percentage 0-100%

  # High Cloud Cover
  - name: HCDC
    description: "High Cloud Cover"
    grib2:
      discipline: 0
      category: 6
      number: 5
    downsample: mean
    levels:
      - type: cloud_layer
        level_code: 234
        display: "high cloud layer"
    style: cloud
    units: "%"
    valid_range: [0, 100]  # Percentage 0-100%

  # ==========================================================================
  # Visibility
  # ==========================================================================
  
  # Visibility
  - name: VIS
    description: "Visibility"
    grib2:
      discipline: 0
      category: 19
      number: 0
    downsample: mean
    levels:
      - type: surface
        level_code: 1
        display: "surface"
    style: visibility
    units: m
    display_units: km
    conversion: m_to_km
    valid_range: [0, 100000]  # 0-100 km visibility

# Composite layers (derived from multiple parameters)
composites:
  - name: WIND_BARBS
    description: "Wind barbs visualization"
    requires: [ UGRD, VGRD ]
    renderer: wind_barbs
    style: wind_barbs
