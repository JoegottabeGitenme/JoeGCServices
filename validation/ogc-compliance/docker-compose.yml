# Docker Compose for OGC Compliance Testing
#
# This creates a test environment where TEAM Engine runs the OGC compliance tests.
# The nginx proxy container is added to the same network and receives requests
# that TEAM Engine makes to "localhost:8080" by using the --add-host option.

services:
  # Proxy that forwards requests to the host's WMS/WMTS service
  proxy:
    image: nginx:alpine
    container_name: ogc-test-proxy
    volumes:
      - ./nginx-proxy.conf:/etc/nginx/conf.d/default.conf:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      ogc-test-net:
        ipv4_address: 172.28.0.10

  # WMS 1.3.0 TEAM Engine
  teamengine-wms:
    image: ogccite/ets-wms13:latest
    container_name: ogc-test-wms
    depends_on:
      - proxy
    ports:
      - "9093:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
      # Map localhost to the proxy container so TEAM Engine's requests 
      # to localhost:8080 hit the proxy which forwards to the host
      - "localhost:172.28.0.10"
    networks:
      - ogc-test-net
    profiles:
      - wms

  # WMTS 1.0.0 TEAM Engine
  teamengine-wmts:
    image: ogccite/ets-wmts10:latest
    container_name: ogc-test-wmts
    depends_on:
      - proxy
    ports:
      - "9094:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
      # Map localhost to the proxy container
      - "localhost:172.28.0.10"
    networks:
      - ogc-test-net
    profiles:
      - wmts

networks:
  ogc-test-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
