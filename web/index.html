<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather WMS Dashboard</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1>üó∫Ô∏è Weather WMS Dashboard</h1>
                <div class="header-right">
                    <div class="status-indicators">
                        <div class="status-item">
                            <span class="status-label">WMS:</span>
                            <a href="http://localhost:8080/wms?SERVICE=WMS&REQUEST=GetCapabilities&VERSION=1.3.0" 
                               target="_blank" 
                               class="status-badge-link"
                               title="Click to open WMS GetCapabilities">
                                <div class="status-badge" id="wms-status">
                                    <span class="status-dot"></span>
                                    <span class="status-text">Checking...</span>
                                </div>
                            </a>
                        </div>
                        <div class="status-item">
                            <span class="status-label">WMTS:</span>
                            <a href="http://localhost:8080/wmts?SERVICE=WMTS&REQUEST=GetCapabilities&VERSION=1.0.0" 
                               target="_blank"
                               class="status-badge-link"
                               title="Click to open WMTS GetCapabilities">
                                <div class="status-badge" id="wmts-status">
                                    <span class="status-dot"></span>
                                    <span class="status-text">Checking...</span>
                                </div>
                            </a>
                        </div>
                    </div>
                    <div class="external-links">
                        <a href="admin.html" class="external-link" title="Open Admin Dashboard">
                            <span class="link-icon">‚öôÔ∏è</span>
                            <span class="link-text">Admin</span>
                        </a>
                        <a href="downloads.html" class="external-link" title="Open Downloads Dashboard">
                            <span class="link-icon">‚¨áÔ∏è</span>
                            <span class="link-text">Downloads</span>
                        </a>
                        <a href="http://localhost:8080/loadtest" target="_blank" class="external-link" title="Open Load Test Dashboard">
                            <span class="link-icon">‚ö°</span>
                            <span class="link-text">Load Tests</span>
                        </a>
                        <a href="benchmarks.html" class="external-link" title="View Criterion Microbenchmark Results">
                            <span class="link-icon">üìâ</span>
                            <span class="link-text">Microbenchmarks</span>
                        </a>
                        <a href="tile-visualizer.html" class="external-link" title="Visualize Tile Requests from Load Tests">
                            <span class="link-icon">üó∫Ô∏è</span>
                            <span class="link-text">Tile Viz</span>
                        </a>
                        <a href="http://localhost:8080/cache" target="_blank" class="external-link" title="Open Cache Viewer">
                            <span class="link-icon">üíæ</span>
                            <span class="link-text">Cache</span>
                        </a>
                        <a href="http://localhost:3000/d/wms-perf/wms-performance?orgId=1&from=now-5m&to=now" target="_blank" class="external-link" title="Open Grafana Performance Dashboard">
                            <span class="link-icon">üìä</span>
                            <span class="link-text">Grafana</span>
                        </a>
                        <a href="http://localhost:9090" target="_blank" class="external-link" title="Open Prometheus">
                            <span class="link-icon">üìà</span>
                            <span class="link-text">Prometheus</span>
                        </a>
                        <a href="http://localhost:9001" target="_blank" class="external-link" title="Open MinIO Console">
                            <span class="link-icon">üóÑÔ∏è</span>
                            <span class="link-text">MinIO</span>
                        </a>
                        <a href="http://localhost:5050" target="_blank" class="external-link" title="Open pgAdmin Database UI">
                            <span class="link-icon">üêò</span>
                            <span class="link-text">pgAdmin</span>
                        </a>
                        <a href="http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/" target="_blank" class="external-link" title="Open Kubernetes Dashboard">
                            <span class="link-icon">‚ò∏Ô∏è</span>
                            <span class="link-text">K8s</span>
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <div class="main-content">
            <!-- Map -->
            <main class="map-container">
                <div id="map"></div>
                
                <!-- Layer Options (Style + Elevation) - positioned under layer control -->
                <div class="layer-options-map" id="layer-options-map">
                    <!-- Style Selector -->
                    <div id="style-selector-container" class="style-selector-container" style="display: none;">
                        <div class="style-selector-label">Style</div>
                        <div class="style-selector-options" id="style-selector-options"></div>
                    </div>
                    
                    <!-- Vertical Level Slider -->
                    <div id="elevation-slider-container" class="elevation-slider-container" style="display: none;">
                        <div class="elevation-slider-label">Level</div>
                        <div class="elevation-slider-track">
                            <input type="range" id="elevation-slider" class="elevation-slider" min="0" max="10" value="0" orient="vertical">
                            <div class="elevation-slider-current" id="elevation-slider-current">
                                <span id="elevation-label">--</span>
                            </div>
                        </div>
                        <div class="elevation-slider-labels" id="elevation-slider-labels"></div>
                    </div>
                </div>
                
                <!-- Time Slider -->
                <div id="time-slider-container" class="time-slider-container" style="display: none;">
                    <div class="time-slider-layer-name" id="time-slider-layer-name">--</div>
                    <div class="time-slider-controls">
                        <button class="time-slider-play-btn" id="time-slider-play-btn" title="Play/Pause">
                            <span class="play-icon">‚ñ∂</span>
                        </button>
                        <button class="time-slider-speed-btn" id="time-slider-speed-btn" title="Playback Speed">
                            <span class="speed-label">1x</span>
                        </button>
                    </div>
                    <div class="time-slider-track">
                        <div class="map-time-slider-bg"></div>
                        <div class="time-slider-progress" id="time-slider-progress"></div>
                        <div class="time-slider-current" id="time-slider-current">
                            <span class="current-time-label" id="current-time-label">--</span>
                        </div>
                        <input type="range" id="map-time-slider" class="map-time-slider" min="0" max="100" value="0">
                        <div class="time-slider-labels" id="time-slider-labels"></div>
                    </div>
                </div>
            </main>

            <!-- Right Sidebar - Status & Validation -->
            <aside class="sidebar sidebar-right">
                <!-- Ingestion Status Section -->
                <div class="sidebar-section ingestion-status-section">
                    <h2>Data Status</h2>
                    <div id="ingestion-status" class="ingestion-status">
                        <div class="status-box compact">
                            <div class="status-row">
                                <span class="label">Service:</span>
                                <div class="status-badge mini" id="ingester-service-status">
                                    <span class="status-dot"></span>
                                    <span class="status-text">--</span>
                                </div>
                            </div>
                            <div class="status-row">
                                <span class="label">Datasets:</span>
                                <span class="value" id="dataset-count">0</span>
                            </div>
                            <div class="status-row">
                                <span class="label">Models:</span>
                                <span class="value" id="models-list">None</span>
                            </div>
                            <div class="status-row">
                                <span class="label">Storage:</span>
                                <span class="value" id="storage-size">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Stats -->
                <div class="sidebar-section performance-section">
                    <h2>Performance</h2>
                    <div id="performance-stats" class="performance-stats compact">
                        <div class="stat-row">
                            <span class="stat-label">Last:</span>
                            <span class="stat-value" id="last-tile-time">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg:</span>
                            <span class="stat-value" id="avg-tile-time">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Tiles:</span>
                            <span class="stat-value" id="tiles-loaded-count">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Slowest:</span>
                            <span class="stat-value" id="slowest-tile-time">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Layer:</span>
                            <span class="stat-value truncate" id="current-layer-name">None</span>
                        </div>
                    </div>
                </div>

                <!-- Backend Metrics Section -->
                <div class="sidebar-section backend-metrics-section">
                    <h2>Backend Metrics</h2>
                    <div id="backend-metrics" class="backend-metrics">
                        <div class="metrics-group">
                            <div class="metrics-group-title">Requests</div>
                            <div class="metric-row">
                                <span class="metric-label">WMS:</span>
                                <span class="metric-value" id="metric-wms-requests">0</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">WMTS:</span>
                                <span class="metric-value" id="metric-wmts-requests">0</span>
                            </div>
                        </div>
                        <div class="metrics-group">
                            <div class="metrics-group-title">Rendering</div>
                            <div class="metric-row">
                                <span class="metric-label">Total:</span>
                                <span class="metric-value" id="metric-renders">0</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Avg:</span>
                                <span class="metric-value" id="metric-render-avg">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Last:</span>
                                <span class="metric-value" id="metric-render-last">--</span>
                            </div>
                        </div>
                        <div class="metrics-group">
                            <div class="metrics-group-title">Cache (Redis)</div>
                            <div class="metric-row">
                                <span class="metric-label">Status:</span>
                                <span class="metric-value" id="metric-cache-status">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Keys:</span>
                                <span class="metric-value" id="metric-cache-keys">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Memory:</span>
                                <span class="metric-value" id="metric-cache-memory">--</span>
                            </div>
                        </div>
                        <div class="metrics-group">
                            <div class="metrics-group-title">System</div>
                            <div class="metric-row">
                                <span class="metric-label">Memory:</span>
                                <span class="metric-value" id="metric-memory">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Threads:</span>
                                <span class="metric-value" id="metric-threads">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Uptime:</span>
                                <span class="metric-value" id="metric-uptime">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Container/Pod Resources Section -->
                <div class="sidebar-section container-stats-section">
                    <h2>Container Resources</h2>
                    <div id="container-stats" class="container-stats">
                        <div class="metrics-group">
                            <div class="metrics-group-title">Memory</div>
                            <div class="metric-row">
                                <span class="metric-label">Used:</span>
                                <span class="metric-value" id="container-mem-used">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Limit:</span>
                                <span class="metric-value" id="container-mem-limit">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Usage:</span>
                                <span class="metric-value" id="container-mem-percent">--</span>
                            </div>
                            <div class="memory-bar-container">
                                <div class="memory-bar" id="container-mem-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="metrics-group">
                            <div class="metrics-group-title">Process</div>
                            <div class="metric-row">
                                <span class="metric-label">RSS:</span>
                                <span class="metric-value" id="container-proc-rss">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">VMS:</span>
                                <span class="metric-value" id="container-proc-vms">--</span>
                            </div>
                        </div>
                        <div class="metrics-group">
                            <div class="metrics-group-title">CPU</div>
                            <div class="metric-row">
                                <span class="metric-label">Cores:</span>
                                <span class="metric-value" id="container-cpu-count">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Load (1m):</span>
                                <span class="metric-value" id="container-load-1m">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Load (5m):</span>
                                <span class="metric-value" id="container-load-5m">--</span>
                            </div>
                        </div>
                        <div class="metrics-group">
                            <div class="metrics-group-title">Environment</div>
                            <div class="metric-row">
                                <span class="metric-label">Container:</span>
                                <span class="metric-value" id="container-type">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Host:</span>
                                <span class="metric-value truncate" id="container-hostname">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- OGC Compliance Section -->
                <div class="sidebar-section validation-section">
                    <h2>OGC Compliance</h2>
                    <div id="validation-status" class="validation-status">
                        <div class="validation-service">
                            <div class="service-header">
                                <span class="service-name">WMS 1.3.0</span>
                                <div class="service-badge" id="wms-validation-badge">
                                    <span class="status-dot"></span>
                                    <span class="status-text">Checking...</span>
                                </div>
                            </div>
                            <div class="validation-checks" id="wms-checks">
                                <div class="check-item">
                                    <span class="check-icon">‚è≥</span>
                                    <span class="check-name">GetCapabilities</span>
                                </div>
                                <div class="check-item">
                                    <span class="check-icon">‚è≥</span>
                                    <span class="check-name">GetMap</span>
                                </div>
                                <div class="check-item">
                                    <span class="check-icon">‚è≥</span>
                                    <span class="check-name">GetFeatureInfo</span>
                                </div>
                                <div class="check-item">
                                    <span class="check-icon">‚è≥</span>
                                    <span class="check-name">Exceptions</span>
                                </div>
                                <div class="check-item">
                                    <span class="check-icon">‚è≥</span>
                                    <span class="check-name">CRS Support</span>
                                </div>
                            </div>
                        </div>

                        <div class="validation-service">
                            <div class="service-header">
                                <span class="service-name">WMTS 1.0.0</span>
                                <div class="service-badge" id="wmts-validation-badge">
                                    <span class="status-dot"></span>
                                    <span class="status-text">Checking...</span>
                                </div>
                            </div>
                            <div class="validation-checks" id="wmts-checks">
                                <div class="check-item">
                                    <span class="check-icon">‚è≥</span>
                                    <span class="check-name">GetCapabilities</span>
                                </div>
                                <div class="check-item">
                                    <span class="check-icon">‚è≥</span>
                                    <span class="check-name">REST Tiles</span>
                                </div>
                                <div class="check-item">
                                    <span class="check-icon">‚è≥</span>
                                    <span class="check-name">KVP Tiles</span>
                                </div>
                                <div class="check-item">
                                    <span class="check-icon">‚è≥</span>
                                    <span class="check-name">TileMatrixSet</span>
                                </div>
                            </div>
                        </div>

                        <div class="validation-footer">
                            <div class="last-checked" id="validation-last-checked">
                                Last checked: Never
                            </div>
                            <button id="run-validation-btn" class="validation-button">
                                Run Validation
                            </button>
                        </div>
                    </div>
                </div>

            </aside>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>Weather WMS Service - Powered by Rust & Leaflet</p>
        </footer>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <!-- Dynamic URL rewriting for K8s/docker-compose compatibility -->
    <script>
        (function() {
            // In docker-compose (port 8000), keep localhost:8080 links
            // In K8s (any other port), rewrite to relative URLs
            if (window.location.port !== '8000') {
                document.querySelectorAll('a[href*="localhost:8080"]').forEach(function(link) {
                    link.href = link.href.replace('http://localhost:8080', '');
                });
            }
        })();
    </script>

    <!-- Application JS -->
    <script src="app.js"></script>
</body>
</html>
