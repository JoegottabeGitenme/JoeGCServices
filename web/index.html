<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather WMS Dashboard</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1>üó∫Ô∏è Weather WMS Dashboard</h1>
                <div class="header-right">
                    <div class="status-indicators">
                        <div class="status-item">
                            <span class="status-label">WMS:</span>
                            <a href="http://localhost:8080/wms?SERVICE=WMS&REQUEST=GetCapabilities&VERSION=1.3.0" 
                               target="_blank" 
                               class="status-badge-link"
                               title="Click to open WMS GetCapabilities">
                                <div class="status-badge" id="wms-status">
                                    <span class="status-dot"></span>
                                    <span class="status-text">Checking...</span>
                                </div>
                            </a>
                        </div>
                        <div class="status-item">
                            <span class="status-label">WMTS:</span>
                            <a href="http://localhost:8080/wmts?SERVICE=WMTS&REQUEST=GetCapabilities&VERSION=1.0.0" 
                               target="_blank"
                               class="status-badge-link"
                               title="Click to open WMTS GetCapabilities">
                                <div class="status-badge" id="wmts-status">
                                    <span class="status-dot"></span>
                                    <span class="status-text">Checking...</span>
                                </div>
                            </a>
                        </div>
                    </div>
                    <div class="external-links">
                        <a href="admin.html" class="external-link" title="Open Admin Dashboard">
                            <span class="link-icon">‚öôÔ∏è</span>
                            <span class="link-text">Admin</span>
                        </a>
                        <a href="http://localhost:8080/loadtest" target="_blank" class="external-link" title="Open Load Test Dashboard">
                            <span class="link-icon">‚ö°</span>
                            <span class="link-text">Load Tests</span>
                        </a>
                        <a href="http://localhost:8080/cache" target="_blank" class="external-link" title="Open Cache Viewer">
                            <span class="link-icon">üíæ</span>
                            <span class="link-text">Cache</span>
                        </a>
                        <a href="http://localhost:3000/d/wms-perf/wms-performance?orgId=1&from=now-5m&to=now" target="_blank" class="external-link" title="Open Grafana Performance Dashboard">
                            <span class="link-icon">üìä</span>
                            <span class="link-text">Grafana</span>
                        </a>
                        <a href="http://localhost:9090" target="_blank" class="external-link" title="Open Prometheus">
                            <span class="link-icon">üìà</span>
                            <span class="link-text">Prometheus</span>
                        </a>
                        <a href="http://localhost:9001" target="_blank" class="external-link" title="Open MinIO Console">
                            <span class="link-icon">üóÑÔ∏è</span>
                            <span class="link-text">MinIO</span>
                        </a>
                        <a href="http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/" target="_blank" class="external-link" title="Open Kubernetes Dashboard">
                            <span class="link-icon">‚ò∏Ô∏è</span>
                            <span class="link-text">K8s</span>
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <div class="main-content">
            <!-- Left Sidebar - Layer Controls -->
            <aside class="sidebar sidebar-left">
                <div class="sidebar-section">
                    <h2>Layer Selection</h2>
                    <div class="control-group">
                        <label>Protocol:</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="protocol" value="wms" class="radio-input">
                                <span class="radio-text">WMS</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="protocol" value="wmts" class="radio-input" checked>
                                <span class="radio-text">WMTS</span>
                            </label>
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="layer-select">Layer:</label>
                        <select id="layer-select" class="control-input">
                            <option value="">Select a layer...</option>
                        </select>
                    </div>

                    <div class="control-group" id="style-group" style="display: none;">
                        <label for="style-select">Style:</label>
                        <select id="style-select" class="control-input">
                            <option value="default">Default</option>
                        </select>
                    </div>

                    <button id="load-layer-btn" class="control-button">Load Layer</button>

                    <div class="control-group" style="margin-top: 1rem;">
                        <label class="checkbox-label">
                            <input type="checkbox" id="enable-query" checked>
                            <span>Enable click-to-query</span>
                        </label>
                    </div>

                    <div id="query-hint" class="query-hint" style="display: none;">
                        üí° Click on the map to query data values
                    </div>
                </div>

                <!-- Model Run & Forecast Controls (for forecast models like GFS, HRRR) -->
                <div class="sidebar-section time-control-section" id="time-control-section" style="display: none;">
                    <h2 id="time-section-title">Model Run & Forecast</h2>
                    <div class="protocol-note" id="time-protocol-note" style="display: none; padding: 0.5rem; background: rgba(255,255,255,0.2); border-radius: 4px; font-size: 0.85rem; color: rgba(255,255,255,0.9); margin-bottom: 0.75rem;">
                        Note: Time controls work with both WMS and WMTS protocols
                    </div>
                    
                    <!-- Forecast Mode Controls (GFS, HRRR) -->
                    <div class="time-controls" id="forecast-controls">
                        <!-- Model Run Selector -->
                        <div class="control-group">
                            <label for="run-select">Model Run (Initialization):</label>
                            <select id="run-select" class="control-input">
                                <option value="latest">Latest Available</option>
                            </select>
                            <div class="help-text">Choose when the model was initialized</div>
                        </div>
                        
                        <!-- Forecast Hour Controls -->
                        <div class="forecast-section">
                            <div class="section-header">
                                <span class="section-label">Forecast Hour</span>
                                <span class="forecast-value" id="current-time-display">F+024</span>
                            </div>
                            <div class="slider-container">
                                <input type="range" id="time-slider" class="time-slider" min="0" max="24" step="3" value="24">
                                <div class="slider-labels">
                                    <span>F+000</span>
                                    <span>F+006</span>
                                    <span>F+012</span>
                                    <span>F+018</span>
                                    <span>F+024</span>
                                </div>
                            </div>
                            <div class="valid-time-display">
                                <span class="valid-time-label">Valid Time:</span>
                                <span class="valid-time-value" id="valid-time-display">--</span>
                            </div>
                            <div class="help-text">Hours into the future from model run</div>
                        </div>
                        
                        <!-- Elevation/Level Selector -->
                        <div class="control-group" id="elevation-group" style="display: none;">
                            <label for="elevation-select">Vertical Level:</label>
                            <select id="elevation-select" class="control-input">
                                <option value="">Surface / Default</option>
                            </select>
                            <div class="help-text">Pressure level or height above ground</div>
                        </div>
                    </div>
                    
                    <!-- Observation Mode Controls (GOES, MRMS) -->
                    <div class="time-controls" id="observation-controls" style="display: none;">
                        <div class="control-group">
                            <label for="observation-time-select">Observation Time:</label>
                            <select id="observation-time-select" class="control-input">
                                <option value="">Select time...</option>
                            </select>
                            <div class="help-text">Time when observation was captured</div>
                        </div>
                        
                        <div class="observation-info">
                            <div class="obs-time-display">
                                <span class="obs-time-label">Current:</span>
                                <span class="obs-time-value" id="current-obs-time-display">--</span>
                            </div>
                            <div class="obs-count">
                                <span class="obs-count-label">Available:</span>
                                <span class="obs-count-value" id="obs-time-count">0 times</span>
                            </div>
                        </div>
                    </div>
                </div>

            </aside>

            <!-- Map -->
            <main class="map-container">
                <div id="map"></div>
            </main>

            <!-- Right Sidebar - Status & Validation -->
            <aside class="sidebar sidebar-right">
                <!-- Ingestion Status Section -->
                <div class="sidebar-section ingestion-status-section">
                    <h2>Data Status</h2>
                    <div id="ingestion-status" class="ingestion-status">
                        <div class="status-box compact">
                            <div class="status-row">
                                <span class="label">Service:</span>
                                <div class="status-badge mini" id="ingester-service-status">
                                    <span class="status-dot"></span>
                                    <span class="status-text">--</span>
                                </div>
                            </div>
                            <div class="status-row">
                                <span class="label">Datasets:</span>
                                <span class="value" id="dataset-count">0</span>
                            </div>
                            <div class="status-row">
                                <span class="label">Models:</span>
                                <span class="value" id="models-list">None</span>
                            </div>
                            <div class="status-row">
                                <span class="label">Storage:</span>
                                <span class="value" id="storage-size">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Stats -->
                <div class="sidebar-section performance-section">
                    <h2>Performance</h2>
                    <div id="performance-stats" class="performance-stats compact">
                        <div class="stat-row">
                            <span class="stat-label">Last:</span>
                            <span class="stat-value" id="last-tile-time">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg:</span>
                            <span class="stat-value" id="avg-tile-time">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Tiles:</span>
                            <span class="stat-value" id="tiles-loaded-count">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Slowest:</span>
                            <span class="stat-value" id="slowest-tile-time">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Layer:</span>
                            <span class="stat-value truncate" id="current-layer-name">None</span>
                        </div>
                    </div>
                </div>

                <!-- Backend Metrics Section -->
                <div class="sidebar-section backend-metrics-section">
                    <h2>Backend Metrics</h2>
                    <div id="backend-metrics" class="backend-metrics">
                        <div class="metrics-group">
                            <div class="metrics-group-title">Requests</div>
                            <div class="metric-row">
                                <span class="metric-label">WMS:</span>
                                <span class="metric-value" id="metric-wms-requests">0</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">WMTS:</span>
                                <span class="metric-value" id="metric-wmts-requests">0</span>
                            </div>
                        </div>
                        <div class="metrics-group">
                            <div class="metrics-group-title">Rendering</div>
                            <div class="metric-row">
                                <span class="metric-label">Total:</span>
                                <span class="metric-value" id="metric-renders">0</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Avg:</span>
                                <span class="metric-value" id="metric-render-avg">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Last:</span>
                                <span class="metric-value" id="metric-render-last">--</span>
                            </div>
                        </div>
                        <div class="metrics-group">
                            <div class="metrics-group-title">Cache (Redis)</div>
                            <div class="metric-row">
                                <span class="metric-label">Status:</span>
                                <span class="metric-value" id="metric-cache-status">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Keys:</span>
                                <span class="metric-value" id="metric-cache-keys">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Memory:</span>
                                <span class="metric-value" id="metric-cache-memory">--</span>
                            </div>
                        </div>
                        <div class="metrics-group">
                            <div class="metrics-group-title">System</div>
                            <div class="metric-row">
                                <span class="metric-label">Memory:</span>
                                <span class="metric-value" id="metric-memory">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Threads:</span>
                                <span class="metric-value" id="metric-threads">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Uptime:</span>
                                <span class="metric-value" id="metric-uptime">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Container/Pod Resources Section -->
                <div class="sidebar-section container-stats-section">
                    <h2>Container Resources</h2>
                    <div id="container-stats" class="container-stats">
                        <div class="metrics-group">
                            <div class="metrics-group-title">Memory</div>
                            <div class="metric-row">
                                <span class="metric-label">Used:</span>
                                <span class="metric-value" id="container-mem-used">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Limit:</span>
                                <span class="metric-value" id="container-mem-limit">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Usage:</span>
                                <span class="metric-value" id="container-mem-percent">--</span>
                            </div>
                            <div class="memory-bar-container">
                                <div class="memory-bar" id="container-mem-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="metrics-group">
                            <div class="metrics-group-title">Process</div>
                            <div class="metric-row">
                                <span class="metric-label">RSS:</span>
                                <span class="metric-value" id="container-proc-rss">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">VMS:</span>
                                <span class="metric-value" id="container-proc-vms">--</span>
                            </div>
                        </div>
                        <div class="metrics-group">
                            <div class="metrics-group-title">CPU</div>
                            <div class="metric-row">
                                <span class="metric-label">Cores:</span>
                                <span class="metric-value" id="container-cpu-count">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Load (1m):</span>
                                <span class="metric-value" id="container-load-1m">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Load (5m):</span>
                                <span class="metric-value" id="container-load-5m">--</span>
                            </div>
                        </div>
                        <div class="metrics-group">
                            <div class="metrics-group-title">Environment</div>
                            <div class="metric-row">
                                <span class="metric-label">Container:</span>
                                <span class="metric-value" id="container-type">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Host:</span>
                                <span class="metric-value truncate" id="container-hostname">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- OGC Compliance Section -->
                <div class="sidebar-section validation-section">
                    <h2>OGC Compliance</h2>
                    <div id="validation-status" class="validation-status">
                        <div class="validation-service">
                            <div class="service-header">
                                <span class="service-name">WMS 1.3.0</span>
                                <div class="service-badge" id="wms-validation-badge">
                                    <span class="status-dot"></span>
                                    <span class="status-text">Checking...</span>
                                </div>
                            </div>
                            <div class="validation-checks" id="wms-checks">
                                <div class="check-item">
                                    <span class="check-icon">‚è≥</span>
                                    <span class="check-name">GetCapabilities</span>
                                </div>
                                <div class="check-item">
                                    <span class="check-icon">‚è≥</span>
                                    <span class="check-name">GetMap</span>
                                </div>
                                <div class="check-item">
                                    <span class="check-icon">‚è≥</span>
                                    <span class="check-name">GetFeatureInfo</span>
                                </div>
                                <div class="check-item">
                                    <span class="check-icon">‚è≥</span>
                                    <span class="check-name">Exceptions</span>
                                </div>
                                <div class="check-item">
                                    <span class="check-icon">‚è≥</span>
                                    <span class="check-name">CRS Support</span>
                                </div>
                            </div>
                        </div>

                        <div class="validation-service">
                            <div class="service-header">
                                <span class="service-name">WMTS 1.0.0</span>
                                <div class="service-badge" id="wmts-validation-badge">
                                    <span class="status-dot"></span>
                                    <span class="status-text">Checking...</span>
                                </div>
                            </div>
                            <div class="validation-checks" id="wmts-checks">
                                <div class="check-item">
                                    <span class="check-icon">‚è≥</span>
                                    <span class="check-name">GetCapabilities</span>
                                </div>
                                <div class="check-item">
                                    <span class="check-icon">‚è≥</span>
                                    <span class="check-name">REST Tiles</span>
                                </div>
                                <div class="check-item">
                                    <span class="check-icon">‚è≥</span>
                                    <span class="check-name">KVP Tiles</span>
                                </div>
                                <div class="check-item">
                                    <span class="check-icon">‚è≥</span>
                                    <span class="check-name">TileMatrixSet</span>
                                </div>
                            </div>
                        </div>

                        <div class="validation-footer">
                            <div class="last-checked" id="validation-last-checked">
                                Last checked: Never
                            </div>
                            <button id="run-validation-btn" class="validation-button">
                                Run Validation
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Ingestion Log (collapsible) -->
                <div class="sidebar-section log-section">
                    <h2>Ingestion Log</h2>
                    <div class="ingest-log" id="ingest-log">
                        <div class="log-entry">Waiting for ingestion data...</div>
                    </div>
                </div>
            </aside>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>Weather WMS Service - Powered by Rust & Leaflet</p>
        </footer>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <!-- Application JS -->
    <script src="app.js"></script>
</body>
</html>
