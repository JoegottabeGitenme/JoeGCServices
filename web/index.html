<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather WMS Dashboard</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1>üó∫Ô∏è Weather WMS Dashboard</h1>
                <div class="header-right">
                    <div class="status-indicators">
                        <div class="status-item">
                            <span class="status-label">WMS:</span>
                            <a href="http://localhost:8080/wms?SERVICE=WMS&REQUEST=GetCapabilities&VERSION=1.3.0" 
                               target="_blank" 
                               class="status-badge-link"
                               title="Click to open WMS GetCapabilities">
                                <div class="status-badge" id="wms-status">
                                    <span class="status-dot"></span>
                                    <span class="status-text">Checking...</span>
                                </div>
                            </a>
                            <button class="compliance-badge" id="wms-compliance-btn" title="OGC WMS 1.3.0 Compliance - Click to revalidate">
                                <span class="status-dot"></span>
                                <span class="compliance-text">Checking...</span>
                            </button>
                        </div>
                        <div class="status-item">
                            <span class="status-label">WMTS:</span>
                            <a href="http://localhost:8080/wmts?SERVICE=WMTS&REQUEST=GetCapabilities&VERSION=1.0.0" 
                               target="_blank"
                               class="status-badge-link"
                               title="Click to open WMTS GetCapabilities">
                                <div class="status-badge" id="wmts-status">
                                    <span class="status-dot"></span>
                                    <span class="status-text">Checking...</span>
                                </div>
                            </a>
                            <button class="compliance-badge" id="wmts-compliance-btn" title="OGC WMTS 1.0.0 Compliance - Click to revalidate">
                                <span class="status-dot"></span>
                                <span class="compliance-text">Checking...</span>
                            </button>
                        </div>
                    </div>
                    <div class="external-links">
                        <a href="admin.html" class="external-link" title="Open Admin Dashboard">
                            <span class="link-icon">‚öôÔ∏è</span>
                            <span class="link-text">Admin</span>
                        </a>
                        <a href="downloads.html" class="external-link" title="Open Downloads Dashboard">
                            <span class="link-icon">‚¨áÔ∏è</span>
                            <span class="link-text">Downloads</span>
                        </a>
                        <a href="http://localhost:8080/loadtest" target="_blank" class="external-link" title="Open Load Test Dashboard">
                            <span class="link-icon">‚ö°</span>
                            <span class="link-text">Load Tests</span>
                        </a>
                        <a href="benchmarks.html" class="external-link" title="View Criterion Microbenchmark Results">
                            <span class="link-icon">üìâ</span>
                            <span class="link-text">Microbenchmarks</span>
                        </a>
                        <a href="tile-visualizer.html" class="external-link" title="Visualize Tile Requests from Load Tests">
                            <span class="link-icon">üó∫Ô∏è</span>
                            <span class="link-text">Tile Viz</span>
                        </a>
                        <a href="http://localhost:3000/d/wms-perf/wms-performance?orgId=1&from=now-5m&to=now" target="_blank" class="external-link" title="Open Grafana Performance Dashboard">
                            <span class="link-icon">üìä</span>
                            <span class="link-text">Grafana</span>
                        </a>
                        <a href="http://localhost:9090" target="_blank" class="external-link" title="Open Prometheus">
                            <span class="link-icon">üìà</span>
                            <span class="link-text">Prometheus</span>
                        </a>
                        <a href="http://localhost:9001" target="_blank" class="external-link" title="Open MinIO Console">
                            <span class="link-icon">üóÑÔ∏è</span>
                            <span class="link-text">MinIO</span>
                        </a>
                        <a href="http://localhost:5050" target="_blank" class="external-link" title="Open pgAdmin Database UI">
                            <span class="link-icon">üêò</span>
                            <span class="link-text">pgAdmin</span>
                        </a>
                        <a href="http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/" target="_blank" class="external-link" title="Open Kubernetes Dashboard">
                            <span class="link-icon">‚ò∏Ô∏è</span>
                            <span class="link-text">K8s</span>
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <div class="info-bar">
            <div class="info-bar-content">
                <!-- System Stats -->
                <div class="info-bar-group">
                    <span class="info-bar-title" title="System resource usage for the WMS API container/process.">System</span>
                    <div class="info-bar-stats">
                        <div class="info-stat" title="Number of CPU cores available to the container.">
                            <span class="info-stat-label">CPUs</span>
                            <span class="info-stat-value" id="info-sys-cpus">-</span>
                        </div>
                        <div class="info-stat" title="System load average over the last 1 minute. Values above CPU count indicate saturation.">
                            <span class="info-stat-label">Load 1m</span>
                            <span class="info-stat-value" id="info-sys-load1">-</span>
                        </div>
                        <div class="info-stat" title="System load average over the last 5 minutes.">
                            <span class="info-stat-label">Load 5m</span>
                            <span class="info-stat-value" id="info-sys-load5">-</span>
                        </div>
                    </div>
                    <div class="info-bar-separator"></div>
                    <div class="info-bar-stats">
                        <div class="info-stat" title="Current memory usage of the WMS API process (RSS - Resident Set Size).">
                            <span class="info-stat-label">RAM Used</span>
                            <span class="info-stat-value" id="info-sys-ram-used">-</span>
                        </div>
                        <div class="info-stat" title="Total system memory available.">
                            <span class="info-stat-label">RAM Total</span>
                            <span class="info-stat-value" id="info-sys-ram-total">-</span>
                        </div>
                        <div class="info-stat" title="Percentage of system memory in use.">
                            <span class="info-stat-label">RAM %</span>
                            <span class="info-stat-value" id="info-sys-ram-pct">-</span>
                        </div>
                    </div>
                    <div class="info-bar-separator"></div>
                    <div class="info-bar-stats">
                        <div class="info-stat" title="How long the WMS API service has been running.">
                            <span class="info-stat-label">Uptime</span>
                            <span class="info-stat-value" id="info-sys-uptime">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Bar -->
        <div class="info-bar">
            <div class="info-bar-content">
                <!-- Cache Stats -->
                <div class="info-bar-group">
                    <span class="info-bar-title" title="Cache for fully rendered PNG tiles. L1 is in-memory (fast), L2 is Redis (persistent).">Tile Cache</span>
                    <div class="info-bar-stats">
                        <span class="info-cache-label" title="L1: In-memory cache. Fastest access (~0ms), but lost on restart.">L1</span>
                        <div class="info-stat" title="Number of tile requests served from L1 in-memory cache (fastest path, ~0ms latency)">
                            <span class="info-stat-label">Hits</span>
                            <span class="info-stat-value" id="info-l1-hits">-</span>
                        </div>
                        <div class="info-stat" title="Percentage of tile requests served from L1 cache. Higher is better - reduces rendering load.">
                            <span class="info-stat-label">Rate</span>
                            <span class="info-stat-value" id="info-l1-rate">-</span>
                        </div>
                        <div class="info-stat" title="Number of tiles currently stored in L1 in-memory cache.">
                            <span class="info-stat-label">Tiles</span>
                            <span class="info-stat-value" id="info-l1-tiles">-</span>
                        </div>
                        <div class="info-stat" title="Current memory usage of L1 in-memory tile cache.">
                            <span class="info-stat-label">Size</span>
                            <span class="info-stat-value" id="info-l1-size">-</span>
                        </div>
                    </div>
                    <div class="info-bar-separator"></div>
                    <div class="info-bar-stats">
                        <span class="info-cache-label" title="L2: Redis cache. Persists across restarts, shared between instances.">L2</span>
                        <div class="info-stat" title="Number of tile requests served from L2 Redis cache (after L1 miss).">
                            <span class="info-stat-label">Hits</span>
                            <span class="info-stat-value" id="info-l2-hits">-</span>
                        </div>
                        <div class="info-stat" title="Percentage of tile requests (after L1 miss) served from L2 Redis cache.">
                            <span class="info-stat-label">Rate</span>
                            <span class="info-stat-value" id="info-l2-rate">-</span>
                        </div>
                        <div class="info-stat" title="Number of tiles stored in L2 Redis cache.">
                            <span class="info-stat-label">Tiles</span>
                            <span class="info-stat-value" id="info-l2-tiles">-</span>
                        </div>
                        <div class="info-stat" title="Memory used by L2 Redis cache for storing rendered tiles.">
                            <span class="info-stat-label">Size</span>
                            <span class="info-stat-value" id="info-l2-size">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="info-bar">
            <div class="info-bar-content">
                <!-- Grid Cache Stats -->
                <div class="info-bar-group">
                    <span class="info-bar-title" title="Cache for parsed weather data grids. Avoids re-parsing GRIB2/NetCDF files on each tile render.">Grid Cache</span>
                    <div class="info-bar-stats">
                        <div class="info-stat" title="Total number of grid parse operations across all data sources. Each render may need to parse source data.">
                            <span class="info-stat-label">Parses</span>
                            <span class="info-stat-value" id="info-grid-parses">-</span>
                        </div>
                        <div class="info-stat" title="Number of times a pre-parsed grid was found in cache, avoiding expensive file parsing.">
                            <span class="info-stat-label">Hits</span>
                            <span class="info-stat-value" id="info-grid-hits">-</span>
                        </div>
                        <div class="info-stat" title="Overall grid cache hit rate across all sources. Higher rates mean faster tile rendering.">
                            <span class="info-stat-label">Rate</span>
                            <span class="info-stat-value" id="info-grid-rate">-</span>
                        </div>
                    </div>
                </div>
                <div class="info-bar-separator"></div>
                <!-- Per-source compact stats -->
                <div class="info-bar-group" id="info-source-stats">
                    <span class="info-source-item" id="info-src-gfs" title="GFS (Global Forecast System) - GRIB2 format&#10;Global model, 0.25¬∞ resolution, 384hr forecasts&#10;Shows: cache hit rate % | avg parse time">
                        <span class="info-source-name">GFS</span>
                        <span class="info-source-rate">-</span>
                        <span class="info-source-time">-</span>
                    </span>
                    <span class="info-source-item" id="info-src-goes" title="GOES (Geostationary Satellite) - NetCDF format&#10;GOES-16/18 imagery, 1-2km resolution, real-time&#10;Shows: cache hit rate % | avg parse time">
                        <span class="info-source-name">GOES</span>
                        <span class="info-source-rate">-</span>
                        <span class="info-source-time">-</span>
                    </span>
                    <span class="info-source-item" id="info-src-hrrr" title="HRRR (High-Resolution Rapid Refresh) - GRIB2 format&#10;CONUS model, 3km resolution, hourly updates, 18hr forecasts&#10;Shows: cache hit rate % | avg parse time">
                        <span class="info-source-name">HRRR</span>
                        <span class="info-source-rate">-</span>
                        <span class="info-source-time">-</span>
                    </span>
                    <span class="info-source-item" id="info-src-mrms" title="MRMS (Multi-Radar Multi-Sensor) - GRIB2 format&#10;Radar composite, 1km resolution, 2-min updates&#10;Shows: cache hit rate % | avg parse time">
                        <span class="info-source-name">MRMS</span>
                        <span class="info-source-rate">-</span>
                        <span class="info-source-time">-</span>
                    </span>
                </div>
            </div>
        </div>

        <div class="info-bar">
            <div class="info-bar-content">
                <!-- Request Stats -->
                <div class="info-bar-group">
                    <span class="info-bar-title" title="Request statistics for WMS and WMTS tile services.">Requests</span>
                    <div class="info-bar-stats">
                        <span class="info-cache-label" title="WMS: Web Map Service - traditional image-based map requests">WMS</span>
                        <div class="info-stat" title="Total number of WMS GetMap requests since service start.">
                            <span class="info-stat-label">Total</span>
                            <span class="info-stat-value" id="info-wms-total">-</span>
                        </div>
                        <div class="info-stat" title="WMS requests in the last 1 minute.">
                            <span class="info-stat-label">1m</span>
                            <span class="info-stat-value" id="info-wms-1m">-</span>
                        </div>
                        <div class="info-stat" title="WMS requests in the last 5 minutes.">
                            <span class="info-stat-label">5m</span>
                            <span class="info-stat-value" id="info-wms-5m">-</span>
                        </div>
                    </div>
                    <div class="info-bar-separator"></div>
                    <div class="info-bar-stats">
                        <span class="info-cache-label" title="WMTS: Web Map Tile Service - tiled map requests (more efficient)">WMTS</span>
                        <div class="info-stat" title="Total number of WMTS tile requests since service start.">
                            <span class="info-stat-label">Total</span>
                            <span class="info-stat-value" id="info-wmts-total">-</span>
                        </div>
                        <div class="info-stat" title="WMTS requests in the last 1 minute.">
                            <span class="info-stat-label">1m</span>
                            <span class="info-stat-value" id="info-wmts-1m">-</span>
                        </div>
                        <div class="info-stat" title="WMTS requests in the last 5 minutes.">
                            <span class="info-stat-label">5m</span>
                            <span class="info-stat-value" id="info-wmts-5m">-</span>
                        </div>
                    </div>
                    <div class="info-bar-separator"></div>
                    <div class="info-bar-stats">
                        <span class="info-cache-label" title="Tile rendering performance statistics">Render</span>
                        <div class="info-stat" title="Total number of tiles rendered (cache misses that required rendering).">
                            <span class="info-stat-label">Total</span>
                            <span class="info-stat-value" id="info-render-total">-</span>
                        </div>
                        <div class="info-stat" title="Tiles rendered in the last 1 minute.">
                            <span class="info-stat-label">1m</span>
                            <span class="info-stat-value" id="info-render-1m">-</span>
                        </div>
                        <div class="info-stat" title="Tiles rendered in the last 5 minutes.">
                            <span class="info-stat-label">5m</span>
                            <span class="info-stat-value" id="info-render-5m">-</span>
                        </div>
                        <div class="info-stat" title="Average tile render time in milliseconds.">
                            <span class="info-stat-label">Avg</span>
                            <span class="info-stat-value" id="info-render-avg">-</span>
                        </div>
                        <div class="info-stat" title="Fastest / Slowest tile render time recorded.">
                            <span class="info-stat-label">Min/Max</span>
                            <span class="info-stat-value" id="info-render-minmax">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="info-bar">
            <div class="info-bar-content">
                <!-- Data Stats -->
                <div class="info-bar-group">
                    <span class="info-bar-title" title="Weather data storage and ingestion statistics.">Data</span>
                    <div class="info-bar-stats">
                        <div class="info-stat" title="Number of weather data files stored in MinIO object storage.">
                            <span class="info-stat-label">Files</span>
                            <span class="info-stat-value" id="info-data-files">-</span>
                        </div>
                        <div class="info-stat" title="Total size of weather data stored in MinIO.">
                            <span class="info-stat-label">Size</span>
                            <span class="info-stat-value" id="info-data-size">-</span>
                        </div>
                        <div class="info-stat" title="Number of ingested datasets (unique model/run/parameter combinations).">
                            <span class="info-stat-label">Datasets</span>
                            <span class="info-stat-value" id="info-data-datasets">-</span>
                        </div>
                        <div class="info-stat" title="Number of unique weather parameters available.">
                            <span class="info-stat-label">Params</span>
                            <span class="info-stat-value" id="info-data-params">-</span>
                        </div>
                    </div>
                    <div class="info-bar-separator"></div>
                    <!-- Per-model stats -->
                    <div class="info-bar-group" id="info-models-stats">
                        <span class="info-model-item" id="info-model-gfs" title="GFS (Global Forecast System)&#10;Global model, 0.25¬∞ resolution&#10;Shows: status | files | parameters">
                            <span class="info-model-name">GFS</span>
                            <span class="info-model-status">-</span>
                            <span class="info-model-files">-</span>
                            <span class="info-model-params">-</span>
                        </span>
                        <span class="info-model-item" id="info-model-hrrr" title="HRRR (High-Resolution Rapid Refresh)&#10;CONUS model, 3km resolution&#10;Shows: status | files | parameters">
                            <span class="info-model-name">HRRR</span>
                            <span class="info-model-status">-</span>
                            <span class="info-model-files">-</span>
                            <span class="info-model-params">-</span>
                        </span>
                        <span class="info-model-item" id="info-model-goes" title="GOES (Geostationary Satellite)&#10;GOES-16/18 imagery, real-time&#10;Shows: status | files | parameters">
                            <span class="info-model-name">GOES</span>
                            <span class="info-model-status">-</span>
                            <span class="info-model-files">-</span>
                            <span class="info-model-params">-</span>
                        </span>
                        <span class="info-model-item" id="info-model-mrms" title="MRMS (Multi-Radar Multi-Sensor)&#10;Radar composite, 1km resolution&#10;Shows: status | files | parameters">
                            <span class="info-model-name">MRMS</span>
                            <span class="info-model-status">-</span>
                            <span class="info-model-files">-</span>
                            <span class="info-model-params">-</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Map -->
            <main class="map-container">
                <div id="map"></div>
                
                <!-- Layer Options (Style + Elevation) - positioned under layer control -->
                <div class="layer-options-map" id="layer-options-map">
                    <!-- Style Selector -->
                    <div id="style-selector-container" class="style-selector-container" style="display: none;">
                        <div class="style-selector-label">Style</div>
                        <div class="style-selector-options" id="style-selector-options"></div>
                    </div>
                    
                    <!-- Vertical Level Slider -->
                    <div id="elevation-slider-container" class="elevation-slider-container" style="display: none;">
                        <div class="elevation-slider-label">Level</div>
                        <div class="elevation-slider-track">
                            <input type="range" id="elevation-slider" class="elevation-slider" min="0" max="10" value="0" orient="vertical">
                            <div class="elevation-slider-current" id="elevation-slider-current">
                                <span id="elevation-label">--</span>
                            </div>
                        </div>
                        <div class="elevation-slider-labels" id="elevation-slider-labels"></div>
                    </div>
                </div>
                
                <!-- Time Slider -->
                <div id="time-slider-container" class="time-slider-container" style="display: none;">
                    <div class="time-slider-layer-name" id="time-slider-layer-name">--</div>
                    <div class="time-slider-controls">
                        <button class="time-slider-play-btn" id="time-slider-play-btn" title="Play/Pause">
                            <span class="play-icon">‚ñ∂</span>
                        </button>
                        <button class="time-slider-speed-btn" id="time-slider-speed-btn" title="Playback Speed">
                            <span class="speed-label">1x</span>
                        </button>
                    </div>
                    <div class="time-slider-track">
                        <div class="map-time-slider-bg"></div>
                        <div class="time-slider-progress" id="time-slider-progress"></div>
                        <div class="time-slider-current" id="time-slider-current">
                            <span class="current-time-label" id="current-time-label">--</span>
                        </div>
                        <input type="range" id="map-time-slider" class="map-time-slider" min="0" max="100" value="0">
                        <div class="time-slider-labels" id="time-slider-labels"></div>
                    </div>
                </div>
            </main>

            <!-- Minimap with Tile Request Heatmap -->
            <aside class="minimap-container">
                <div class="minimap-wrapper">
                    <div class="minimap-header">
                        <span class="minimap-title">Tile Requests</span>
                        <button class="minimap-clear-btn" id="minimap-clear-btn" title="Clear heatmap">Clear</button>
                    </div>
                    <div id="minimap"></div>
                    <div class="minimap-legend">
                        <span class="minimap-legend-item">
                            <span class="legend-color" style="background: #3b82f6;"></span>
                            <span class="legend-label">Low</span>
                        </span>
                        <span class="minimap-legend-item">
                            <span class="legend-color" style="background: #10b981;"></span>
                            <span class="legend-label">Med</span>
                        </span>
                        <span class="minimap-legend-item">
                            <span class="legend-color" style="background: #f59e0b;"></span>
                            <span class="legend-label">High</span>
                        </span>
                        <span class="minimap-legend-item">
                            <span class="legend-color" style="background: #ef4444;"></span>
                            <span class="legend-label">Hot</span>
                        </span>
                    </div>
                    <div class="minimap-stats">
                        <div class="minimap-stat">
                            <span class="minimap-stat-label">Requests</span>
                            <span class="minimap-stat-value" id="minimap-request-count">0</span>
                        </div>
                        <div class="minimap-stat">
                            <span class="minimap-stat-label">Hotspots</span>
                            <span class="minimap-stat-value" id="minimap-hotspot-count">0</span>
                        </div>
                    </div>
                </div>
                <div class="minimap-bottom"></div>
            </aside>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>Weather WMS Service - Powered by Rust & Leaflet</p>
        </footer>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <!-- Dynamic URL rewriting for K8s/docker-compose compatibility -->
    <script>
        (function() {
            // In docker-compose (port 8000), keep localhost:8080 links
            // In K8s (any other port), rewrite to relative URLs
            if (window.location.port !== '8000') {
                document.querySelectorAll('a[href*="localhost:8080"]').forEach(function(link) {
                    link.href = link.href.replace('http://localhost:8080', '');
                });
            }
        })();
    </script>

    <!-- Application JS -->
    <script src="app.js"></script>
</body>
</html>
